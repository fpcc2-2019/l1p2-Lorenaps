---
title: "Sessões, buscas e navegação na wikimedia"
author: "Lorena Pereira"
date: "8 de maio de 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

A partir da base de dados https://github.com/wikimedia-research/Discovery-Hiring-Analyst-2016
e do tratamento feito em https://github.com/fpcc2-2019/l1p2-Lorenaps
vamos responder as seguintes perguntas:

```{r echo=FALSE}
library(tidyverse)
library(here)
library(lubridate)
library(ggplot2)
theme_set(theme_bw())

buscas = read_csv(here::here("data/search_data.csv")) %>% 
    mutate(day = round_date(session_start_date, unit = "day")) 

```

## 1 - Qual é a nossa taxa de cliques geral diária? Como isso varia entre os grupos?

*taxa de cliques: a proporção de sessões de pesquisa em que o usuário clicou em um dos resultados exibidos*

Para calcular a taxa consideramos = Sessões em que houveram clique (por dia) / Total de sessoes (por dia)

Para calcular o total de sessões existentes independente da o ocorrência de cliques foi preciso agrupar por dias e depois somar, pois existem sessões que se repetem em alguns dias. Como observado abaixo:

```{r}
buscas %>% filter(session_id == "8cf57f4f99f96220") %>% group_by(session_id, day) %>% count()
```

#### Taxa diária


```{r}

total_busca = buscas %>% 
    group_by(session_id, day, group) %>% 
    count() %>% 
    group_by(session_id, day, group) %>% 
    count() %>%
    group_by(day, group) %>%
    count() %>%
    rename(total = n)

busca_com_clicks = buscas %>% 
    filter(num_clicks > 0) %>%
    group_by(session_id, day, group) %>% 
    count() %>% 
    group_by(session_id, day, group) %>% 
    count() %>%
    group_by(day, group) %>%
    count() %>%
    rename(parcial = n)

merge_busca = merge(total_busca, busca_com_clicks, by = c("day", "group")) 

merge_busca %>% 
    group_by(day) %>%
    summarise(sum_parcial = sum(parcial), sum_total = sum(total)) %>% 
    mutate(taxa = sum_parcial / sum_total) %>%
    ggplot(aes(x = day, y = taxa)) + 
    geom_jitter(aes(size = taxa, color = taxa))

merge_busca %>% 
    group_by(day) %>%
    summarise(sum_parcial = sum(parcial), sum_total = sum(total)) %>% 
    mutate(taxa = sum_parcial / sum_total) %>%
    ggplot(mapping = aes(x = day, y = taxa)) + 
    geom_line() +
    geom_point()

```

#### Taxa diária por grupo

```{r}
merge_busca %>% 
    mutate(taxa = parcial / total) %>%
    ggplot(mapping = aes(x = day, y = taxa, color=group)) + 
    geom_line() +
    geom_point()

```

## 2 - Quais resultados as pessoas tendem a tentar primeiro? Como isso muda no dia-a-dia?

```{r}
buscas %>%
    filter(!is.na(first_click)) %>%
    group_by(first_click) %>%
    count() %>%
    arrange(desc(n))


```
É visível que as pessoas preferem o primeiro resultado. Mas o que acontece quando olhamos esse dados ao longo do dia?

```{r}

buscas = buscas %>%
    mutate(turno = case_when(hour(session_start_date) >= 0 & hour(session_start_date) < 12 ~ "Manhã", 
                            hour(session_start_date) >= 12 & hour(session_start_date) < 18 ~ "Tarde", 
                            hour(session_start_date) >= 18 & hour(session_start_date) <= 23 ~ "Noite"))

buscas %>%   
    filter(!is.na(first_click)) %>%
    group_by(first_click, turno) %>%
    count() %>%
    arrange(desc(n))
    
```

Observando ao longo do dia elas continuam consumindo mais o primeiro resultado.
É possível observar uma diferança muito grando do primeiro resultado para o segundo e assim sucessivamente. 
Vamos explorar um pouco mais o que acontecem com aquels que não são o primeiro resultado.

```{r}
buscas %>% 
    ggplot(mapping = aes(x = first_click, y = search_index)) + 
    geom_jitter(aes(alpha=0.4)) + 
    ggtitle("Relação entre ordem dos resultados e preferencia dos usuários") + 
    guides(alpha = FALSE, color = FALSE) 
```


## 3 - Qual é a nossa taxa de resultados zero no geral? Como isso varia entre os grupos?
taxa de resultados zero: a proporção de pesquisas que resultaram em 0 resultados

```{r}

total_results = buscas %>% 
    group_by(day, group) %>% 
    count() %>% 
    rename(total = n)

zero_results = buscas %>% 
    filter(results == 0) %>%
    group_by(day, group) %>% 
    count() %>% 
    rename(parcial = n)

merge_results = merge(zero_results, total_results, by = c("day", "group")) 

merge_results %>% 
    group_by(day) %>%
    summarise(sum_parcial = sum(parcial), sum_total = sum(total)) %>% 
    mutate(taxa = sum_parcial / sum_total) %>%
    ggplot(mapping = aes(x = day, y = taxa)) + 
    geom_line() +
    geom_point()

```


```{r}
merge_results %>% 
    mutate(taxa = parcial / total) %>%
    ggplot(mapping = aes(x = day, y = taxa, color=group)) + 
    geom_line() + 
    geom_point()

```

## 4 - A duração da sessão é aproximadamente o tempo entre o primeiro e o último evento de uma sessão. Escolha uma variável do conjunto de dados e descreva sua relação com o tamanho da sessão. Visualize o relacionamento.

```{r}

duracao = buscas %>% 
    group_by(session_id, session_length) %>%
    summarise(sum_results = sum(results)) %>%
    mutate(tempo_em_minutos = session_length / 60)

duracao %>% 
    ggplot(mapping = aes(x = sum_results, y = tempo_em_minutos)) + 
    geom_jitter(aes(size = sum_results, alpha=0.4)) + 
    ggtitle("Relação entre resultados de busca e duração da sessão") + 
    labs(x="Resultados por sessão", y="Duração por sessão (em minutos)", size = "Resultados") + 
    guides(alpha = FALSE, color = FALSE) 

```

Nesse gráfico é possível perceber que não existe uma relação direta entre a quantidade de resultados de busca obtidos em uma sessão e o tempo que gasto naquela sessão. É possível considerar essa hipotese se considerarmos que o usuário pode ficar indeciso diante de muitos resultados e isso o leve a passar mais tempo pesquisando ou olhando a lista de resultados. Mas isso não é determinante porque mesmo com uma lista grande de resultados é possível que os primeiros já atendam a necessidade do usuário, bem como um lista de resultados menores, o que nesse caso pode ter sido influenciado por uma string de busca mais específica e que trouxe resultados de forma mais eficaz.
