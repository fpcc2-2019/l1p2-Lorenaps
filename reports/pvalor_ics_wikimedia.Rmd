---
title: "R Notebook"
output: html_notebook
---

# Reanálise do exercício da Wikimedia com Intervalo de Confiança e Teste de Hipótese

```{r echo=FALSE}
library(tidyverse)
library(here)
library(lubridate)
library(ggplot2)
theme_set(theme_bw())

buscas = read_csv(here::here("data/search_data.csv")) %>% 
    mutate(day = round_date(session_start_date, unit = "day")) 

```

## A Tarefa 
Considerando que os dados da wikimedia que usamos no Laboratório 2, faça uma inferência sobre como é, na população de todas as sessões do site: 
1. A diferença entre o clickthrough rate dos grupos A e B; e 
2. A diferença na proporção buscas com zero resultados nos grupos A e B


## 1 - A diferença entre o clickthrough rate dos grupos A e B

```{r}

total_busca = buscas %>% 
    group_by(session_id, day, group) %>% 
    count() %>% 
    group_by(session_id, day, group) %>% 
    count() %>%
    group_by(day, group) %>%
    count() %>%
    rename(total = n)

busca_com_clicks = buscas %>% 
    filter(num_clicks > 0) %>%
    group_by(session_id, day, group) %>% 
    count() %>% 
    group_by(session_id, day, group) %>% 
    count() %>%
    group_by(day, group) %>%
    count() %>%
    rename(parcial = n)

merge_busca = merge(total_busca, busca_com_clicks, by = c("day", "group")) 

merge_busca = merge_busca %>% 
    mutate(taxa = parcial / total)

```


### Teste de hipótese
```{r}
library(resample)
options(scipen=999)

p = permutationTest2(merge_busca, 
                     mean(taxa), 
                     treatment = as.factor(group))
p$stats$PValue
```

### Intervalo de confiança

Função para cálculo da diferença média
```{r}
theta_diferenca_media = function(df, i){
    
    busca_a = df %>%
        filter(group == "a") %>%
        rename(taxa_a = "taxa") %>%
        select(day, taxa_a)

    busca_b = df %>%
        filter(group == "b") %>%
        rename(taxa_b = "taxa") %>%
        select(day, taxa_b)
    
    busca_a_b = merge(busca_a, busca_b, by="day")

    diferenca_media = busca_a_b %>% 
        slice(i) %>% 
        mutate(diferenca = taxa_a - taxa_b) %>%
        summarise(mean_diff = mean(diferenca)) %>%
        pull(mean_diff)
    
    return(diferenca_media)
}

diferenca_media = theta_diferenca_media(merge_busca, 1:NROW(merge_busca))
diferenca_media
```

Fazendo bootstrap
```{r}
library(boot)
library(broom)

booted <- boot(data = merge_busca, 
               statistic = theta_diferenca_media, 
               R = 4000)

ci = tidy(booted, 
          conf.level = .95,
          conf.method = "basic",
          conf.int = TRUE)
ci
```

## 2 - A diferença na proporção buscas com zero resultados nos grupos A e B
```{r}

total_results = buscas %>% 
    group_by(group) %>% 
    count() %>% 
    rename(total = n)

zero_results = buscas %>% 
    filter(results == 0) %>%
    group_by(group) %>% 
    count() %>% 
    rename(parcial = n)

merge_results = merge(zero_results, total_results, by = c("group")) 

merge_results = merge_results %>% 
    mutate(taxa = parcial / total)

merge_results
```

### Teste de Hipótese
```{r}
library(resample)
options(scipen=999)

p = permutationTest2(merge_results, 
                     mean(taxa), 
                     treatment = as.factor(group))
p$stats$PValue
```


### Intervalo de Confiança

Função para calular a diferença entre os grupos
```{r}

theta_diferenca_grupos = function(df, i){
    
    diferenca = df %>% 
        slice(i) %>%
        select(taxa, group) %>%
        gather(Var, Val, - group) %>%
        group_by(group) %>% 
        spread(group, Val) %>%
        rename(taxa_a = "a", taxa_b = "b") %>%
        summarise(diferenca_grupos = taxa_a - taxa_b) %>%
        pull(diferenca_grupos)
    
    return(diferenca)
}

diferenca = theta_diferenca_grupos(merge_results, 1:NROW(merge_results))
diferenca

```

Fazendo bootstrap
```{r}
booted_results <- boot(data = merge_busca, 
               statistic = theta_diferenca_grupos, 
               R = 4000)

ci_results = tidy(booted_results, 
          conf.level = .95,
          conf.method = "basic",
          conf.int = TRUE)
ci_results
```